# Интеграция с Home Assistant

Интеграция OpenHASP с Home Assistant выполняется в несколько этапов.

## 1. Установка HACS
Если HACS еще не установлен, воспользуйтесь [официальной инструкцией](https://hacs.xyz/docs/setup/prerequisites). Для большинства установок достаточно выполнить команду в терминале HA:
```bash
wget -O - https://get.hacs.xyz | bash -
```
После этого перезагрузите Home Assistant.

## 2. Установка компонента OpenHASP через HACS
1. Откройте Home Assistant.
2. Перейдите в **HACS** → **Интеграции**.
3. Нажмите **Explore & Download Repositories**.
4. Найдите **openHASP**.
5. Выберите версию **0.7.0** (рекомендуется для стабильной работы с данным проектом).
6. Нажмите **Download**.
7. Перезагрузите Home Assistant.

## 3. Настройка MQTT брокера
Устройство взаимодействует с Home Assistant через протокол MQTT.
- Убедитесь, что у вас установлен и настроен аддон **Mosquitto broker** (см. подробнее в [docs/mqtt-setup.md](mqtt-setup.md)).
- Создайте отдельного пользователя для MQTT в HA (**Настройки** → **Люди** → **Пользователи**).

## 4. Добавление интеграции в Home Assistant
1. Перейдите в **Настройки** → **Устройства и службы**.
2. Нажмите **Добавить интеграцию**.
3. Найдите **openHASP**.
4. Введите параметры:
   - **MQTT base topic**: `hasp/plate01` (где `plate01` — это Hostname вашего устройства).
   - **Name of the plate**: `plate01`.

## 5. Управление реле и навигация
После успешного деплоя в Home Assistant появятся следующие возможности:
- **Управление реле**: В интеграции openHASP появятся сущности для управления встроенными реле (например, `openhasp.plate01_p2b11`). Они автоматически синхронизируются с кнопками на экране.
- **Глобальная навигация**: В нижней части экрана появится панель навигации (высота 40px). Активная страница подсвечивается оранжевым цветом.
- **Синхронизация состояния**: Состояние реле и текущей страницы передается в HA через MQTT в реальном времени.

## 6. Загрузка конфигурации
После настройки интеграции и деплоя через Ansible, файлы `*_openhasp_homeassistant.yaml` будут автоматически подключены в `configuration.yaml` с помощью `!include_dir_named`.

Если автоматическое подключение не сработало, добавьте в `configuration.yaml`:

```yaml
openhasp: !include_dir_named includes/openhasp
```

Это позволит Home Assistant автоматически загружать конфигурации для каждого устройства из папки `includes/openhasp/`.

## Полезные ссылки
- [Документация по интеграции с HA](https://openhasp.com/0.7.0/integrations/home-assistant/installation/)
- [HACS Official Website](https://hacs.xyz/)
