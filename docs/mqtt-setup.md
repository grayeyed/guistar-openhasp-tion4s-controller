# Настройка MQTT (Сервер и Клиент)

Для взаимодействия панели с Home Assistant необходимо настроить MQTT брокер (сервер) и само устройство (клиент).

## 1. Настройка MQTT сервера (Home Assistant)

### Установка Mosquitto Broker
1. Перейдите в **Настройки** → **Надстройки**.
2. Нажмите **Магазин надстроек**, найдите и установите **Mosquitto broker**.
3. Запустите надстройку.

### Создание пользователя MQTT
Для безопасности рекомендуется создать отдельного пользователя:
1. Перейдите в **Настройки** → **Люди**.
2. Вкладка **Пользователи** (если не видите, включите "Расширенный режим" в профиле пользователя).
3. Нажмите **Добавить пользователя**.
4. Имя: `mqtt-user`, Пароль: `ваш_пароль`.
5. Установите галочку "Разрешить вход только из локальной сети".

## 2. Настройка MQTT клиента (OpenHASP устройство)

Настройка выполняется через веб-интерфейс устройства.

### Доступ к настройкам
1. Откройте в браузере IP-адрес устройства.
2. Перейдите в **Configuration** → **MQTT Settings**.

### Параметры подключения
- **Hostname**: **КРИТИЧЕСКИ ВАЖНО**. Это имя должно точно совпадать с именем файла конфигурации в `ansible/host_vars/`.
  - *Пример*: Если вы используете `ansible/host_vars/plate01.yml`, укажите здесь `plate01`.
- **Broker**: IP-адрес вашего сервера Home Assistant.
- **Port**: `1883` (по умолчанию).
- **User**: имя пользователя, созданного в HA (например, `mqtt-user`).
- **Password**: пароль этого пользователя.

После сохранения настроек устройство перезагрузится. Оно будет использовать топик `hasp/HOSTNAME/` для обмена данными.

## 3. Сбор параметров для конфигурации Ansible

Для работы Ansible плейбука необходимо подготовить файлы переменных в папках `ansible/group_vars/` и `ansible/host_vars/`.

### Порядок сбора entity_id
Для управления бризером Tion 4S и отображения данных сенсоров необходимо найти ID соответствующих сущностей в Home Assistant:

1. Откройте Home Assistant и перейдите в **Инструменты разработчика** → **Состояния**.
2. В поле фильтра введите `tion`, чтобы найти все сущности, относящиеся к бризеру.
3. Вам необходимо найти и скопировать `entity_id` для следующих **обязательных** параметров:
   - **Климат**: сущность типа `climate.*` (например, `climate.tion_4s`). Это значение для `climate_entity`.
   - **Boost переключатель**: сущность типа `switch.*_boost`. Это значение для `boost_switch`.
   - **Boost таймер**: сущность типа `sensor.*_boost_time_left`. Это значение для `boost_time_sensor`.
   - **Boost настройка**: сущность типа `number.*_boost_time`. Это значение для `boost_time_number`.

4. (Опционально) Найдите ID сенсоров для отображения в углах экрана:
   - Температура, влажность, CO2, производительность, мощность нагревателя, ресурс фильтра.

### Настройка переменных
1. Настройте общие параметры в `ansible/group_vars/all.yml` (на основе `all.yml.example`).
2. Создайте файл настроек для конкретного устройства `ansible/host_vars/plate01.yml` (на основе `plate01.yml.example`).
3. Заполните его собранными данными, соблюдая структуру:

```yaml
device:
  name: "plate01" # Имя вашего устройства

homeassistant:
  # Обязательные параметры
  climate_entity: "climate.tion_4s"
  boost_switch: "switch.tion_4s_boost"
  boost_time_sensor: "sensor.tion_4s_boost_time_left"
  boost_time_number: "number.tion_4s_boost_time"

  # Необязательные параметры (можно закомментировать или удалить)
  leftcorner_line_one:
    sensor: "sensor.temperature"
    unit: "°C"
  # ... и так далее
```

Эти параметры будут использованы для генерации `openhasp_homeassistant.yaml` (для Home Assistant) и `pages.jsonl` (для устройства). Настройку MQTT на самом устройстве необходимо выполнить вручную через веб-интерфейс OpenHASP.
