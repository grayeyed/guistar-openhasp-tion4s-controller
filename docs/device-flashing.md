# Прошивка устройства

## Подготовка
1. Подключите устройство к компьютеру через USB-C порт.
2. Убедитесь, что установлены драйверы для CP210x или CH340 (в зависимости от ревизии платы).

## Способы прошивки

### 1. Через PlatformIO (рекомендуется)
Если вы собирали прошивку самостоятельно:
```bash
pio run -e esp32-s3-4848S040 -t upload
```

### 2. Через ESPTool (командная строка)
```bash
esptool.py --chip esp32s3 --port /dev/ttyUSB0 erase_flash
esptool.py --chip esp32s3 --port /dev/ttyUSB0 write_flash -z 0x0 firmware.bin
```

## Начальная настройка WiFi

При первой загрузке (или если настройки WiFi не найдены) устройство создаст точку доступа для настройки.

### Способ 1: Через тач-скрин
1. На экране отобразится QR-код и данные точки доступа.
2. Нажмите на экран, чтобы запустить калибровку (коснитесь 4 углов).
3. Используйте экранную клавиатуру для ввода SSID и пароля вашей сети.
4. Нажмите галочку в углу для сохранения.

### Способ 2: Через веб-интерфейс (AP Mode)
1. Подключитесь к точке доступа устройства (сканируйте QR или найдите сеть `openhasp-xxxx`).
2. Откройте в браузере `http://192.168.4.1`.
3. Введите SSID и пароль вашей WiFi сети и нажмите **Save Settings**.
4. Устройство перезагрузится и подключится к вашей сети.

### Способ 3: Через серийную консоль
Вы можете настроить WiFi командами через терминал:
```text
ssid Your_WiFi_Name
pass Your_WiFi_Password
reboot
```

## Настройка встроенных реле (GPIO)

Для использования встроенных реле в панели GUISTAR необходимо настроить GPIO в веб-интерфейсе OpenHASP. Это позволит управлять реле локально и передавать их состояние в Home Assistant.

1. Перейдите в **Configuration** -> **GPIO Settings**.
2. Добавьте новые выходы (**Add New Pin Output**) и настройте их следующим образом:
   - **Реле 1**: Pin 40, Group 1
   - **Реле 2**: Pin 2, Group 2
   - **Реле 3**: Pin 1, Group 3
3. Убедитесь, что тип выхода установлен как **Power Relay** или **Light Relay**.
4. Сохраните настройки и перезагрузите устройство.

> **Важно**: Номера групп (Group) должны соответствовать тем, что указаны в конфигурации Ansible (`host_vars`). По умолчанию используются группы 1, 2 и 3.

## Полезные ссылки
- [Подробное руководство по прошивке OpenHASP](https://openhasp.com/0.7.0/firmware/flashing/)
- [Официальная документация по сборке](https://openhasp.com/0.7.0/firmware/compiling/)
- [ESPTool Documentation](https://docs.espressif.com/projects/esptool/en/latest/)
